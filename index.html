<!DOCTYPE HTML>

<html>
    <head>
        <link rel="stylesheet" type="text/css" href="e2e.css">		
    </head>
   
    <body>
        <script src="./e2e.js" type="text/javascript">
        </script>

        <div id="main">
            <div id="logo-space">
                <img id="logo" src="image/Logo_ArmPelion_White.bc9f68a5a605.svg"/>
            </div>

            <div id="title">Pelion Device ManagementサービスAPIを使用してデバイスと接続する</div>

            <div id="lead">
                <p>
                    これは、Pelion Device Managementとクライアントデバイス間のデバイス通信の対話型サンプルページです。
                </p>
                <p>
                    Pelion Device ManagementサービスAPIを使用して、デプロイされたデバイスと通信する方法を理解することが出来ます。
                </p>
                <p>
                    この使用例のソースコードは<a href="https://github.com/toyowata/Pelion-device-e2e-example/tree/gh-pages">こちら</a>です。
                </p>
            </div>



            <h1>事前準備</h1>
            <p>
                このページを使用するには、以下の準備が必要です。
                <ul>
                    <li>Pelion Device Management APIキー (<a href="https://www.pelion.com/docs/device-management/current/user-account/api-keys.html#creating-a-key">Get API key</a>)</li>
                    <li><a href="https://github.com/ARMmbed/mbed-cloud-client-example">mbed-cloud-client-example</a> または <a href="https://github.com/ARMmbed/mbed-os-example-pelion">mbed-os-example-pelion</a>が書き込まれたデバイス</li>
                </ul>
            </p>



            <h1>APIキー</h1>
            <p>
                APIキーを入力します（APIキーは、ak_...から始まる文字列です）。 APIキーと取得方法については
                <a href="https://www.pelion.com/docs/device-management/current/user-account/api-keys.html">オンラインドキュメント</a>を参照してください。
            </p>
            <div class="operation">
                <input id="apikey" type="text" size="80" value="" placeholder="ak_..."/><br/>
                <input id="storeApiKey" type="checkbox" name="storeApiKey" onclick="handleApiKeyCheckbox()"/>
                <label for="storeApiKey">APIキーをCookieに保存する（プライベートブラウザでのみ使用してください）</label>
            </div>



            <h1>Event notificationチャネルを開き、デバイスからイベントを受信する</h1>
            <p>
                デバイスからのメッセージを受信するには、Event notificationチャネルを開く必要があります。この例では WebSocket notificationチャネルを使用しています。
            </p>
            <p>
                以下の手順で、WebSocketを使用することが出来ます。この手順の詳細は、
                <a href="https://www.pelion.com/docs/device-management/current/integrate-web-app/event-notification.html#websocket-interface">こちら</a>を参照してください。一つのAPIキーでオープンできるnotificationチャネルは、一つだけです。
            </p>

            <h2>WebSocket notificationチャネルの作成</h2>
            <p>
                まず最初に<a href="https://www.pelion.com/docs/device-management/current/integrate-web-app/event-notification.html">Event notificationチャネル</a>を開きます。
                下のボタンをクリックし、 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#registerWebsocket">PUT /v2/notification/websocket</a> サービスAPIを使用してWebSocket notificationチャネルを作成します。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=0:18&footer=minimal"></script>
                <button type="button" onclick="createWebSocketNotificationChannel()">このコードを実行</button>
            </div>
            
            <h2>WebSocket notificationチャネルに接続</h2>
            <p>
                WebSocket notificationチャネルを作成した後に、
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#connectWebsocket">GET /v2/websocket-connect</a> サービスAPIを使用して接続します。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=19:90&footer=minimal"></script>
                <button type="button" onclick="connectWebSocket()">このコードを実行</button>
            </div>
            <p>
                これでイベント通知チャンネルが開きました。デフォルトでは、デバイスのライフタイムイベント（Register, Register-Update and Expire）を受け取ることができます。
            </p>



            <h1>デバイスとの接続</h1>
            <p>
                電源を入れるかリセットを行ってデバイスをPelionに接続します。
                <b>reqistration</b> または <b>reg-update</b>イベントが下記の<b>Notification Channel</b>に表示されているはずです。
            </p>
            <h2>デバイスの選択</h2>
            <p>
                まず、下の「このコードを実行」ボタンをクリックすると、<b>registered</b>状態のデバイスが表示されます。
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-directory.html#deviceList">GET /v3/devices</a> はデバイスリストの取得に使用されます。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=91:115&footer=minimal"></script>
                <button type="button" onclick="getRegisteredDevices()">このコードを実行</button>
            </div>
            <p>
                上のボタンをクリックすると、下のリストに登録されているデバイスが表示されます。対象のデバイスを選択してください。
            </p>
            <div class="operation">
                <select id="deviceSelector">
                    <option value="00000000000000000000000000000000">上のボタンを押して登録されたデバイスを取得してください</option>
                </select>
            </div>



            <h1>デバイスのリソースに書き込む</h1>
            <p>
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#createAsyncRequest">POST /v2/device-requests</a> でデバイスにリソースアップデートリクエストを送ります。
                詳細は説明は、<a href="https://www.pelion.com/docs/device-management/current/device-management/handle-resource-webapp.html#the-write-operation">こちら</a>を参照してください。
            </p>
            <p>
                書き込みリクエストでデバイスの設定を行うことができます。このアプリケーションの例ではLEDを点滅できますが、"pattern_resource"/3201/0/5853に書き込み、新しい点滅パターンを設定してみましょう。
                このリソースのデフォルト値は、"500:500:500:500"です。これを、"500:1000:500:1000"に変更してみます。この値はBase64にエンコードされる必要があるので、スクリプトで変換処理します。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=116:136&footer=minimal"></script>
                Pattern: <input id="blinkPattern" type="text" size="30" value="500:1000:500:1000" /><br /><br />
                <button type="button" onclick="writeResource( getDeviceId(), '/3201/0/5853', document.getElementById('blinkPattern').value)">このコードを実行</button>
            </div>
            <p>
                デバイスがリクエストを受け入れた場合、Notification Channelに非同期レスポンスが表示されます。また、デバイスのユーザーLEDが500ms、1000ms、500ms、1000msと指定したパターンで点滅します。
            </p>
            


            <h1>デバイスからリソースを読み込む</h1>
            <p> 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#createAsyncRequest">POST /v2/device-requests</a> でデバイスにリソース読み込みリクエストを送ることができます。
                詳細は説明は、<a href="https://www.pelion.com/docs/device-management/current/device-management/handle-resource-webapp.html#the-read-operation">こちら</a>を参照してください。
            </p>
            <p>
                ここでは、デジタル入力カウンタ /3200/0/5501 リソースを読み込んでみます。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=137:156&footer=minimal"></script>
                <button type="button" onclick="readResource( getDeviceId(), '/3200/0/5501')">このコードを実行</button>
            </div>

            <p>
                <b>キャッシュに関して</b><br/>
                デバイスのクライアントでmax-age値が設定されている場合、デバイスから読み込まれた値はmax-age用にキャッシュされます:
                <a href="https://www.pelion.com/docs/device-management/current/connecting/device-guidelines.html#resource-cache">https://www.pelion.com/docs/device-management/current/connecting/device-guidelines.html#resource-cache</a>
                キャッシュされた値が有効な場合、それがレスポンスとして返されます。ウェブアプリがキャッシュされた値ではなく、デバイスから現在の値を取得する必要がある場合、デバイスクライアントで max-age を 0 (デフォルトは 0) に設定する必要があります。
            </p>



            <h1>リソースのサブスクライブ</h1>

            <h2>サブスクライブ</h2>
            <p>
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#addResourceSubscription">PUT /v2/subscription/{device-id}/{resourcePath}</a> でデバイスのリソースをサブスクライブします。
            </p>
            <p>
                ここでは、デジタル入力カウンタ /3200/0/5501 リソースをサブスクライブします。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=157:173&footer=minimal"></script>
                <button type="button" onclick="subscribeResource( getDeviceId(), '/3200/0/5501')">このコードを実行</button>
            </div>
            <p>
                非同期レスポンスを受信し、その後にリソース変更の通知が表示されます。
            </p>

            <h2>サブスクライブの停止</h2>
            <p>
                リソースのサブスクライブを停止する場合、 
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#deleteResourceSubscription">DELETE /v2/subscriptions/{device-id}/{resourcePath}</a> を使用します。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=174:190&footer=minimal"></script>
                <button type="button" onclick="unsubscribeResource( getDeviceId(), '/3200/0/5501')">このコードを実行</button>
            </div>



            <h1>リソースのプリサブスクライブ</h1>
            <p>
                リソースをプリサブスクライブするには、<a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#updatePreSubscriptions">PUT /v2/subscriptions</a> を使用します。
            </p>
            <p>
                プリサブスクリプションは、与えられたルールに基づいてリソースを自動的にサブスクライブします。
                リソースを持つデバイスが設定されたルールに一致すると、デバイス管理コネクトサービスは、アプリケーションに代わってデバイスにサブスクリプション（監視）要求を送信します。
                プリサブスクリプションの詳細は、<a href="https://www.pelion.com/docs/device-management/current/device-management/resource-change-webapp.html#presubscriptions">このドキュメント</a>を参照してください。
            </p>

            <h2>サブスクライブ</h2>
            <p>
                デジタル入力カウンタ /3200/0/5501 リソースをプリサブスクライブします。プリサブスクライブするには、<a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#updatePreSubscriptions">PUT /v2/subscriptions</a> を使用します。
                この場合、デジタル入力カウンタ/3200/0/5501リソースを持つデバイスは、デバイスが登録または更新登録を行うと自動的にサブスクライブされます。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=191:211&footer=minimal"></script>
                <button type="button" onclick="presubscribe( getDeviceId(),'/3200/0/5501')">このコードを実行</button>
            </div>
            <p>
                リセットボタンを押してデバイスを再起動してみてください。リソース/3200/0/5501は自動的にサブスクライブされ、Notificationチャンネルに通知が表示されます。
            </p>

            <h2>サブスクライブの停止</h2>
            <p>
                プリサブスクリプションを解除するには、<a href="">DELETE /v2/subscriptions</a> を使用します。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=211:228&footer=minimal"></script>
                <button type="button" onclick="unpresubscribe()">このコードを実行</button>
            </div>



            <h1>リソースの通知ルールを設定する</h1>
            <p>
                ウェブアプリケーションは、オブジェクト、オブジェクトインスタンス、またはリソースにルールベースのサブスクリプションを設定することができます。
            </p>

            <h2>サブスクライブ</h2>
            <p>
                通知ルールの設定以外に、/3200/0/5501のサブスクライブが必要なので注意してください。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=157:173&footer=minimal"></script>
                <button type="button" onclick="subscribeResource( getDeviceId(), '/3200/0/5501')">このコードを実行</button>
            </div>

            <h2>通知ルールの設定</h2>
            <p>
                デバイスは5秒ごとにデジタル入力カウンタ/3200/0/5501を更新し、Pelionデバイス管理サービスに報告します。
                しかし、ウェブアプリは1分ごとにしかデータが必要なく、冗長なデータを受信したくない場合があります。
                このような場合、最小レポート期間を設定する通知ルールpminを使用することができます。
                通知ルールの詳細は、
                <a href="https://www.pelion.com/docs/device-management/current/device-management/resource-change-webapp.html#notification-rules">こちら</a>を参照してください。
            </p>
            <p>
                デジタル入力カウンタ/3200/0/5501のサブスクリプションに1分のpminを設定するには、<a href="https://www.pelion.com/docs/device-management/current/service-api-references/connect-api.html#DeviceRequests">POST /v2/device-request</a> でtMinを指定します。
                URIフィールドにリソースパスをpmin=60で指定します。これはスクリプトで行います。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=228:248&footer=minimal"></script>
                <button type="button" onclick="setFilterParameter( getDeviceId(), '/3200/0/5501', 'pmin=60')">このコードを実行</button>
            </div>

            <h2>サブスクライブの停止</h2>
            <p>
                リソースのサブスクライブを停止するには、
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#deleteResourceSubscription">DELETE /v2/subscriptions/{device-id}/{resourcePath}</a> を使用します。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=174:190&footer=minimal"></script>
                <button type="button" onclick="unsubscribeResource( getDeviceId(), '/3200/0/5501')">このコードを実行</button>
            </div>

            

            <h1>WebSocket notificationチャネルの削除</h1>
            <p>
                最後に、APIキーにバインドされているWebSocket notificationチャネルを削除します。
                <a href="https://www.pelion.com/docs/device-management/current/service-api-references/device-management-connect.html#deleteWebsocket">DELETE /v2/notification/websocket</a> を使用します。
                これは、チャンネルをwebsocketから別のタイプに変更するために必要です。
            </p>
            <div class="operation">
                <script src="https://gist-it.appspot.com/github/coisme/Pelion-device-e2e-example/blob/v0.1.0/e2e.js?slice=248:265&footer=minimal"></script>
                <button type="button" onclick="deleteWebSocketNotificationChannel()">このコードを実行</button>
            </div>
            <p>
                - 以上 -
            </p>
        </div>

        <div id="logs">
            <div class="terminal-container">
                <b>Events</b>
                <div id="event_log" class="terminal"></div>
            </div>
            <div class="terminal-container">
                    <b>Notification Channel</b>
                    <div id="notification_channel" class="terminal"></div>
            </div>
            <div class="terminal-container">
                <b>Device Events</b>
                <div id="device_data_events" class="terminal"></div>
            </div>
            <button type="button" onclick="ClearEventLog()">Clear All</button>
        </div>
        
    </body>
</html>
